<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">
        <style>
            * {
                font-family: 'Nunito', sans-serif;
            }
            h1 {
                width: 100px;
                float: left;
                text-align: center;
            }
            #whiteboard {
                display: none;
                width: 1300px;
                height: 600px;
                background-color: lightgray;
                margin-top: 63px;
            }
        </style>
    </head>
    <body>
        <div>
            <h1>Zira</h1>
            <input type="button" value="Game" onclick="showGame();" />
            <input type="button" value="Whiteboard" onclick="showWhiteboard();" />
        </div>
        <div id="whiteboard">
            <h2>
                WhiteBoard goes here
            </h2>
        </div>
        <div id="game"></div>
        <script>
            const phaserConfig = {
                type: Phaser.AUTO,
                parent: "game",
                width: 1300,
                height: 600,
                backgroundColor: "#E7F6EF",
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: false,
                    }
                },
                dom: {
                    createContainer: true
                },
                scene: {
                    init: initScene,
                    preload: preloadScene,
                    create: createScene,
                    update: updateScene
                }
            }

            const game = new Phaser.Game(phaserConfig);
            let idGame;

            function initScene() {
                this.socket = io("http://localhost:3000", { autoConnect: false });
                this.chatMessages = [];
                this.otherPlayers = this.physics.add.group();
            }

            function preloadScene() {
                this.load.html("form", "form.html");
                this.load.image('bg', 'assets/background.jpeg');
                this.load.spritesheet('player', 'assets/spritexb-3320.png', { frameWidth: 32, frameHeight: 48 });
            }

            function createScene() {
                this.textInput = this.add.dom(1200, 580).createFromCache("form").setOrigin(0.5);
                this.chat = this.add.text(1065, 1, "", {
                    lineSpacing: 15,
                    backgroundColor: "#21313CDD",
                    color: "#40b9c1",
                    padding: 10,
                    fontStyle: "bold"
                });
                this.chat.setFixedSize(270, 535);
                this.chat.setDepth(1);

                // Player
                this.bg = this.add.image(0, 0, 'bg').setOrigin(0, 0).setDisplaySize(1300, 600);
                let inputUsername = localStorage.getItem("username");
                this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);
                this.enterKey.on("down", event => {
                    let chatBox = this.textInput.getChildByName("chat");
                    if (chatBox.value != "") {
                        this.socket.emit("message", inputUsername + ": " + chatBox.value);
                        chatBox.value = "";
                    }
                });

                this.socket.connect();
                this.socket.on("connect", async () => {
                    let room = localStorage.getItem("room");
                    this.socket.emit("join", room);
                });
                let self = this;
                
                this.socket.on("joined", (players, gameId) => {
                    this.chatMessages.push("Welcome to your class!");
                    if (this.chatMessages.length > 20) {
                        this.chatMessages.shift();
                    }
                    this.chat.setText(this.chatMessages);
                    idGame = gameId;
                    Object.keys(players).forEach(function (id) {
                        if (players[id].playerId === self.socket.id) {
                            addPlayer(self, players[id]);
                        } else if (players[id].gameId === gameId) {
                            addOtherPlayers(self, players[id])
                        }
                    });

                    console.log(gameId, '------> gameId');
                    console.log(inputUsername, '------> inputusername');
                    console.log(this.otherPlayers, '------> otherPlayer');
                    console.log(this.player, '------> player');
                });

                this.socket.on("message", (message) => {
                    this.chatMessages.push(message);
                    if (this.chatMessages.length > 20) {
                        this.chatMessages.shift();
                    }
                    this.chat.setText(this.chatMessages);
                });

                this.socket.on('newPlayer', function (playerInfo) {
                    console.log(playerInfo, '------> New Playerinfo')
                    addOtherPlayers(self, playerInfo);
                });

                this.socket.on('disconnect', function (playerId) {
                    self.otherPlayers.getChildren().forEach(function (otherPlayer) {
                        if (playerId === otherPlayer.playerId) {
                            otherPlayer.destroy();
                        }
                    });
                });

                this.socket.on('playerMoved', function (playerInfo) {
                    self.otherPlayers.getChildren().forEach(function (otherPlayer) {
                        if (playerInfo.playerId === otherPlayer.playerId) {
                            otherPlayer.setPosition(playerInfo.x, playerInfo.y);
                            otherPlayer.anims.play(playerInfo.playerAnim.key, true)
                        }
                    });
                });


                // =========== ANIMATIONS START=============
                this.anims.create({
                    key: "left",
                    frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }),
                    frameRate: 100,
                    repeat: 0,
                });

                this.anims.create({
                    key: "right",
                    frames: this.anims.generateFrameNumbers('player', { start: 8, end: 11 }),
                    frameRate: 100,
                    repeat: 0,
                });

                this.anims.create({
                    key: "up",
                    frames: this.anims.generateFrameNumbers('player', { start: 12, end: 15 }),
                    frameRate: 100,
                    repeat: 0,
                });

                this.anims.create({
                    key: "down",
                    frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
                    frameRate: 100,
                    repeat: 0,
                });
                // =========== ANIMATIONS END =============
            }

            function updateScene() {
                this.keyLeft = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
                this.keyRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
                this.keyUp = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
                this.keyDown = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
                
                if (this.player) {
                    if (this.keyLeft.isDown) {
                        this.player.anims.play('left', true);
                        this.player.x -= 10;
                    } else if (this.keyRight.isDown) {
                        this.player.anims.play('right', true);
                        this.player.x += 10;
                    } else if (this.keyUp.isDown) {
                        this.player.anims.play('up', true);
                        this.player.y -= 10;
                    } else if (this.keyDown.isDown) {
                        this.player.anims.play('down', true);
                        this.player.y += 10;
                    } else {
                        this.player.setVelocity(0, 0);
                    }

                    let x = this.player.x;
                    let y = this.player.y;
                    let playerAnim = this.player.anims.currentAnim;
                    if (this.player.oldPosition && (x !== this.player.oldPosition.x || y !== this.player.oldPosition.y)) {
                        this.socket.emit('playerMovement', { x: this.player.x, y: this.player.y, playerAnim: this.player.anims.currentAnim });
                    }

                    this.player.oldPosition = {
                        x: this.player.x,
                        y: this.player.y,
                        playerAnim: this.player.anims.currentAnim,
                    };
                }
            }

            function addPlayer(self, playerInfo) {
                self.player = self.physics.add.sprite(playerInfo.x, playerInfo.y, 'player').setOrigin(0, 0)
                    .setDisplaySize(38, 42)
                    .setCollideWorldBounds(true);
            }

            function addOtherPlayers(self, playerInfo) {
                const otherPlayer = self.add.sprite(playerInfo.x, playerInfo.y, 'player').setOrigin(0, 0)
                    .setDisplaySize(38, 42);
                otherPlayer.playerId = playerInfo.playerId;
                self.otherPlayers.add(otherPlayer);
            }

            // Show and hide Game, Whiteboard
            function showGame() {
                document.getElementById('game').style.display = "block";
                document.getElementById('whiteboard').style.display = "none";
            }

            function showWhiteboard() {
                document.getElementById('game').style.display = "none";
                document.getElementById('whiteboard').style.display = "block";
            }
        </script>
    </body>
</html>